---
sidebar_position: 2
---

# アーキテクチャ

このドキュメントは、BrowserBeeのアーキテクチャ、コンポーネント構造、およびコード構成の詳細な概要を提供します。

## 概要

BrowserBeeは、4つの主要なモジュールを持つモジュラーエージェントアーキテクチャを使用しています：

- **エージェントモジュール** – ユーザーの指示を処理し、ブラウザアクションにマッピング
- **バックグラウンドモジュール** – タブ制御、メッセージング、タスクストリーミングを管理
- **UIモジュール** – 対話と設定のためのクリーンなサイドバーインターフェースを提供
- **モデルモジュール** – 複数のLLMプロバイダーに対して柔軟なインターフェースを提供

## 詳細なアーキテクチャ

### モデルモジュール

モデルモジュールは、複数のLLMプロバイダーに対して柔軟なインターフェースを提供します：

- **models/providers/types.ts**：すべてのプロバイダーの共通インターフェース
  - `ModelInfo`：モデルに関する情報（名前、価格など）
  - `ProviderOptions`：プロバイダーの設定オプション
  - `StreamChunk`：ストリーミング応答の共通形式
  - `LLMProvider`：すべてのプロバイダーが実装する必要があるインターフェース

- **models/providers/factory.ts**：プロバイダーを作成するファクトリー関数
  - 設定に基づいて適切なプロバイダーを作成

- **models/providers/anthropic.ts**：Anthropic Claudeプロバイダーの実装
  - Claude固有のストリーミングと機能を処理
  - Claudeの思考機能をサポート

- **models/providers/openai.ts**：OpenAI GPTプロバイダーの実装
  - OpenAI固有のストリーミングと機能を処理

- **models/providers/gemini.ts**：Google Geminiプロバイダーの実装
  - Gemini固有のストリーミングと機能を処理

- **models/providers/ollama.ts**：Ollamaプロバイダーの実装
  - ローカルで実行されているOllamaモデルに接続
  - ブラウザ互換バージョンのOllamaライブラリを使用
  - ローカルモデルからのストリーミング応答をサポート

- **models/providers/ollama-format.ts**：Ollamaメッセージ形式トランスフォーマー
  - AnthropicとOllamaのメッセージ形式間で変換
  - ツールと画像を含む複雑なメッセージ構造を処理

- **models/providers/openai-compatible.ts**：OpenAI互換プロバイダーの実装
  - 互換性のあるOpenAI固有のストリーミングと機能を処理

### エージェントモジュール

エージェントモジュールは、ユーザーの指示を処理し、ブラウザ自動化タスクを実行する責任があります。いくつかのサブモジュールで構成されています：

- **agent/AgentCore.ts**：すべてのコンポーネントを調整するメインエージェントクラス
  - プロバイダーファクトリーを使用して適切なLLMプロバイダーを作成
  - さまざまなLLMプロバイダーで設定可能
- **agent/TokenManager.ts**：トークン推定とメッセージ履歴のトリミング
- **agent/ToolManager.ts**：ヘルスチェック付きのツールラッピング
- **agent/PromptManager.ts**：システムプロンプト生成
- **agent/MemoryManager.ts**：メモリルックアップと統合
- **agent/ErrorHandler.ts**：キャンセルとエラー処理
- **agent/ExecutionEngine.ts**：ストリーミングおよび非ストリーミング実行
  - 任意のLLMプロバイダーで動作するプロバイダー非依存の実装
- **agent/approvalManager.ts**：機密性の高いアクションに対するユーザー承認を処理

- **agent/tools/**：機能ごとに整理されたブラウザ自動化ツール
  - **navigationTools.ts**：ブラウザナビゲーション関数（URL移動、戻る、進む、更新）
  - **interactionTools.ts**：ユーザーインタラクション関数（クリック、入力、スクロール）
  - **observationTools.ts**：ページ観察関数（スクリーンショット、DOMアクセス、コンテンツ抽出）
  - **mouseTools.ts**：マウス移動とインタラクション（移動、ホバー、ドラッグ）
  - **keyboardTools.ts**：キーボード入力関数（キーを押す、キーボードショートカット）
  - **tabTools.ts**：タブ管理関数（作成、切り替え、タブを閉じる）
  - **memoryTools.ts**：メモリの保存と取得関数
  - **types.ts**：ツールの型定義
  - **utils.ts**：ツールのユーティリティ関数
  - **index.ts**：ツールのエクスポートと登録

### バックグラウンドモジュール

バックグラウンドモジュールは、タブ制御と通信を含む拡張機能のバックグラウンドプロセスを管理します。

- **background/index.ts**：バックグラウンドスクリプトのエントリーポイント
- **background/tabManager.ts**：タブのアタッチと管理
  - タブへの接続を処理
  - タブの状態とライフサイクルを管理
  - タブのインタラクションを調整
- **background/agentController.ts**：エージェントの初期化と実行
  - エージェントを作成して設定
  - ユーザーの指示を処理
  - エージェントの実行フローを管理
- **background/streamingManager.ts**：ストリーミング機能
  - エージェント応答のストリーミングを処理
  - 応答のセグメンテーションを管理
  - ストリーミング状態を制御
- **background/messageHandler.ts**：メッセージルーティングと処理
  - コンポーネント間のメッセージを処理
  - メッセージを適切なハンドラーにルーティング
  - メッセージキューを管理
- **background/configManager.ts**：プロバイダー設定管理
  - プロバイダー設定を保存および取得
  - プロバイダー設定要件を検証
  - グローバルアクセスのためのシングルトンインスタンスを提供
- **background/types.ts**：バックグラウンドプロセスの型定義
- **background/utils.ts**：バックグラウンドプロセスのユーティリティ関数

### UIモジュール

UIモジュールは、拡張機能とのやり取りのためのユーザーインターフェースを提供します。

#### サイドパネル

サイドパネルは、BrowserBeeとのやり取りのためのメインインターフェースです。モジュラーコンポーネント構造にリファクタリングされています：

- **sidepanel/SidePanel.tsx**：UIを調整するメインコンポーネント
  - すべてのUIコンポーネントを構成
  - フックを通じて状態と機能を調整
  - 全体的なレイアウトと構造を管理

- **sidepanel/types.ts**：サイドパネルの型定義
  - メッセージタイプとインターフェース
  - Chromeメッセージインターフェース
  - その他の共有タイプ

- **sidepanel/components/**：モジュラーUIコンポーネント
  - **LlmContent.tsx**：ツール呼び出しを含むLLMコンテンツをレンダリング
    - マークダウンコンテンツを処理して表示
    - ツール呼び出しの特別な書式設定を処理
    - さまざまなコンテンツ要素にスタイリングを適用
  - **ScreenshotMessage.tsx**：スクリーンショット画像をレンダリング
    - base64エンコードされたスクリーンショットを表示
    - 画像の書式設定とサイズ設定を処理
  - **MessageDisplay.tsx**：さまざまなメッセージタイプのレンダリングを処理
    - メッセージフィルタリングを管理
    - システム、LLM、スクリーンショットメッセージのレンダリングを調整
    - ストリーミングセグメントを処理
  - **OutputHeader.tsx**：トグルコントロール付きの出力セクションヘッダーを管理
    - 履歴をクリアするためのコントロールを提供
    - システムメッセージの表示切り替えを管理
  - **PromptForm.tsx**：入力フォームと送信を処理
    - プロンプト入力を管理
    - フォーム送信を処理
    - 処理中のキャンセル機能を提供
  - **TabStatusBar.tsx**：現在のタブ情報を表示
    - アクティブなタブIDとタイトルを表示
    - 接続状態を示す
  - **TokenUsageDisplay.tsx**：トークン使用量とプロバイダー情報を表示
    - 現在のLLMプロバイダーとモデルを表示
    - 入力トークンと出力トークンを追跡
    - 推定コストを表示

- **sidepanel/hooks/**：状態と機能のためのカスタムReactフック
  - **useTabManagement.ts**：タブ関連機能を管理
    - タブ接続を処理
    - タブ状態を追跡
    - タブ情報を更新
  - **useMessageManagement.ts**：メッセージ状態と処理を処理
    - メッセージ履歴を管理
    - ストリーミング状態を制御
    - メッセージ操作関数を提供
  - **useChromeMessaging.ts**：Chrome拡張機能APIとの通信を管理
    - Chromeメッセージをリッスン
    - バックグラウンドスクリプトにメッセージを送信
    - メッセージ処理を処理

#### オプションページ

- **options/Options.tsx**：オプションUIを調整するメインコンポーネント
  - 状態と設定を管理
  - すべてのオプションコンポーネントを構成
- **options/index.tsx**：オプションページのエントリーポイント
- **options/components/**：オプションページのモジュラーUIコンポーネント
  - **AboutSection.tsx**：「について」情報を表示
  - **ProviderSelector.tsx**：プロバイダーの選択を処理
  - **AnthropicSettings.tsx**、**OpenAISettings.tsx**、**GeminiSettings.tsx**、**OllamaSettings.tsx**：プロバイダー固有の設定
  - **OpenAICompatibleSettings.tsx**：OpenAI互換プロバイダーの設定
  - **ModelList.tsx**：OpenAI互換プロバイダーのモデルリストを管理
  - **OllamaModelList.tsx**：Ollamaプロバイダーのカスタムモデルリストを管理
  - **ModelPricingTable.tsx**：モデル価格情報を表示
  - **MemoryManagement.tsx**：メモリのエクスポート/インポート機能を処理
  - **SaveButton.tsx**：設定保存機能を管理
  - **LLMProviderConfig.tsx**：プロバイダーの選択と設定を組み合わせる
  - **ProviderSettings.tsx**：適切なプロバイダー設定コンポーネントをレンダリング

### トラッキングモジュール

トラッキングモジュールは、メモリストレージ、トークン追跡、およびその他の追跡関連機能を処理します。

- **tracking/memoryService.ts**：エージェントメモリのストレージと取得を管理
  - IndexedDB操作を処理
  - メモリのストレージと取得を提供
  - 自己修復データベース機能を含む
- **tracking/tokenTrackingService.ts**：API呼び出しのトークン使用量を追跡
- **tracking/screenshotManager.ts**：スクリーンショットのストレージと取得を管理
- **tracking/domainUtils.ts**：ドメインを操作するためのユーティリティ

## データフロー

1. ユーザーがサイドパネルにプロンプトを入力
2. プロンプトがバックグラウンドモジュールに送信される
3. バックグラウンドモジュールが設定されたLLMプロバイダーでエージェントを初期化
4. エージェントがプロンプトを処理し、ブラウザアクションを実行：
   - TokenManagerがトークン推定と履歴トリミングを処理
   - PromptManagerがシステムプロンプトを生成
   - ExecutionEngineが実行フローを管理
   - ToolManagerがブラウザツールへのアクセスを提供
   - MemoryManagerが関連するメモリを統合
   - ErrorHandlerがエラー条件を管理
5. 結果がサイドパネルにストリーミングされる
6. サイドパネルが結果をユーザーに表示

## コンポーネントの関係

- サイドパネルはChromeメッセージングを通じてバックグラウンドモジュールと通信
- バックグラウンドモジュールはエージェントを管理し、そのアクションを調整
- エージェントコアは特殊なコンポーネント（TokenManager、ToolManagerなど）を調整
- 各特殊なコンポーネントはエージェントの機能の特定の側面を処理
- エージェントはツールを使用してブラウザとやり取り
- トラッキングモジュールは永続性と監視サービスを提供
- オプションページはバックグラウンドモジュールで使用される拡張機能設定を構成
- モデルモジュールは複数のLLMプロバイダーに対して柔軟なインターフェースを提供

## プロバイダーシステム

## Ollama統合

Ollama統合により、ユーザーはローカルで実行されているOllamaモデルに接続できます：

1. **ブラウザ互換性**：ブラウザ互換バージョンのOllamaライブラリを使用
2. **APIキーオプション**：他のプロバイダーとは異なり、OllamaはAPIキーを必要としません
3. **CORS設定**：OllamaサーバーでCORSを有効にする必要があります
4. **カスタムモデル**：設定可能なコンテキストウィンドウを持つユーザー定義のカスタムモデルをサポート
5. **設定要件**：ベースURLと少なくとも1つのカスタムモデルが設定されている必要があります
6. **プライバシー重視**：クラウドベースのLLMプロバイダーに対するプライバシー重視の代替手段を提供

プロバイダーシステムは、これらの設計パターンに従います：

1. **インターフェース分離**：各プロバイダーは共通インターフェースを実装
2. **ファクトリーパターン**：ファクトリー関数が適切なプロバイダーを作成
3. **アダプターパターン**：各プロバイダーは特定のAPIを共通インターフェースに適応
4. **ストラテジーパターン**：さまざまなプロバイダーを実行時に交換可能
5. **シングルトンパターン**：ConfigManagerが設定への単一のアクセスポイントを提供

## ファイル構成

プロジェクトは、明確な関心の分離を持つモジュラー構造に従います：

- 各モジュールには独自のディレクトリがあります
- コンポーネントは機能ごとに整理されています
- 型は使用される場所の近くで定義されています
- フックは関連する状態と機能をカプセル化します
- ユーティリティ関数は専用のファイルに分離されています

## 設計原則

1. **関心の分離**：各コンポーネントとモジュールには単一の責任があります
2. **モジュール性**：コンポーネントとモジュールは独立して開発およびテストできます
3. **再利用性**：共通機能は再利用可能なコンポーネントとフックに抽出されます
4. **型安全性**：TypeScriptがプロジェクト全体で型安全性のために使用されます
5. **保守性**：コードは理解しやすく保守しやすいように整理されています
6. **回復力**：重要なコンポーネントには自己修復メカニズムが実装されています
7. **ライフサイクル管理**：拡張機能のインストール、更新、アンインストールが適切に処理されます
8. **プロバイダー抽象化**：LLMプロバイダーは共通インターフェースの背後に抽象化されています
