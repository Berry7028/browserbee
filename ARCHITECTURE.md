# BrowserBee アーキテクチャ

このドキュメントは、BrowserBee のアーキテクチャ、コンポーネント構成、コードの整理について詳しく説明します。

## 概要

BrowserBee は、4つの主要モジュールからなるモジュラー型エージェントアーキテクチャを採用しています。

- **エージェントモジュール** – ユーザー指示を処理し、ブラウザ操作にマッピング
- **バックグラウンドモジュール** – タブ制御、メッセージング、タスクストリーミング管理
- **UIモジュール** – インタラクションと設定用のサイドバーインターフェースを提供
- **モデルモジュール** – 複数のLLMプロバイダーに対応する柔軟なインターフェース

## 詳細アーキテクチャ

### モデルモジュール

モデルモジュールは、複数のLLMプロバイダーに対応する柔軟なインターフェースを提供します。

- **models/providers/types.ts**: 全プロバイダー共通のインターフェース
  - `ModelInfo`: モデル情報（名前、価格など）
  - `ProviderOptions`: プロバイダー設定オプション
  - `StreamChunk`: ストリーミングレスポンスの共通フォーマット
  - `LLMProvider`: 全プロバイダーが実装すべきインターフェース

- **models/providers/factory.ts**: プロバイダー生成用ファクトリー関数
  - 設定に応じて適切なプロバイダーを生成

- **models/providers/anthropic.ts**: Anthropic Claude プロバイダー実装
  - Claude固有のストリーミングや機能を処理
  - Claudeのthinking機能対応

- **models/providers/openai.ts**: OpenAI GPT プロバイダー実装
  - OpenAI固有のストリーミングや機能を処理

- **models/providers/gemini.ts**: Google Gemini プロバイダー実装
  - Gemini固有のストリーミングや機能を処理

- **models/providers/ollama.ts**: Ollama プロバイダー実装
  - ローカルで稼働するOllamaモデルに接続
  - ブラウザ対応版Ollamaライブラリ使用
  - ローカルモデルからのストリーミングレスポンス対応

- **models/providers/ollama-format.ts**: Ollamaメッセージフォーマット変換
  - AnthropicとOllama間のメッセージフォーマット変換
  - ツールや画像を含む複雑なメッセージ構造対応

### エージェントモジュール

エージェントモジュールは、ユーザー指示の処理とブラウザ自動化タスクの実行を担当します。サブモジュール構成：

- **agent/AgentCore.ts**: 全コンポーネントを統括するメインエージェントクラス
  - プロバイダーファクトリーで適切なLLMプロバイダー生成
  - 複数LLMプロバイダーに対応可能
- **agent/TokenManager.ts**: トークン推定とメッセージ履歴のトリミング
- **agent/ToolManager.ts**: ツールラッピングとヘルスチェック
- **agent/PromptManager.ts**: システムプロンプト生成
- **agent/MemoryManager.ts**: メモリ検索と統合
- **agent/ErrorHandler.ts**: キャンセルとエラー処理
- **agent/ExecutionEngine.ts**: ストリーミング/非ストリーミング実行
  - どのLLMプロバイダーでも動作するプロバイダー非依存実装
- **agent/approvalManager.ts**: 機密操作のユーザー承認管理

- **agent/tools/**: 機能別に整理されたブラウザ自動化ツール
  - **navigationTools.ts**: ブラウザナビゲーション（URL移動、戻る、進む、リフレッシュ）
  - **interactionTools.ts**: ユーザー操作（クリック、入力、スクロール）
  - **observationTools.ts**: ページ観察（スクリーンショット、DOMアクセス、内容抽出）
  - **mouseTools.ts**: マウス操作（移動、ホバー、ドラッグ）
  - **keyboardTools.ts**: キーボード入力（キー押下、ショートカット）
  - **tabTools.ts**: タブ管理（作成、切替、閉じる）
  - **memoryTools.ts**: メモリ保存・取得
  - **types.ts**: ツール用型定義
  - **utils.ts**: ツール用ユーティリティ
  - **index.ts**: ツールのエクスポートと登録

### バックグラウンドモジュール

バックグラウンドモジュールは、拡張機能のバックグラウンド処理（タブ制御・通信等）を管理します。

- **background/index.ts**: バックグラウンドスクリプトのエントリポイント
- **background/tabManager.ts**: タブ接続・管理
  - タブへの接続
  - タブ状態・ライフサイクル管理
  - タブ操作の調整
- **background/agentController.ts**: エージェント初期化・実行
  - エージェント生成・設定
  - ユーザー指示の処理
  - エージェント実行フロー管理
- **background/streamingManager.ts**: ストリーミング機能
  - エージェントレスポンスのストリーミング処理
  - レスポンスの分割管理
  - ストリーミング状態制御
- **background/messageHandler.ts**: メッセージルーティング・処理
  - コンポーネント間メッセージ処理
  - 適切なハンドラーへのルーティング
  - メッセージキュー管理
- **background/configManager.ts**: プロバイダー設定管理
  - 設定保存・取得
  - 設定要件の検証
  - グローバルアクセス用シングルトン提供
- **background/types.ts**: バックグラウンド処理用型定義
- **background/utils.ts**: バックグラウンド処理用ユーティリティ

### UIモジュール

UIモジュールは、拡張機能のユーザーインターフェースを提供します。

#### サイドパネル

サイドパネルは、BrowserBeeとの主なインターフェースです。モジュラー型コンポーネント構成にリファクタ済み：

- **sidepanel/SidePanel.tsx**: UI全体を統括するメインコンポーネント
  - 全UIコンポーネントの構成
  - フックによる状態・機能の調整
  - レイアウト・構造管理

- **sidepanel/types.ts**: サイドパネル用型定義
  - メッセージ型・インターフェース
  - Chromeメッセージインターフェース
  - その他共通型

- **sidepanel/components/**: モジュラー型UIコンポーネント
  - **LlmContent.tsx**: ツール呼び出し付きLLMコンテンツ表示
    - Markdownコンテンツの処理・表示
    - ツール呼び出し用特別フォーマット対応
    - 要素ごとのスタイリング
  - **ScreenshotMessage.tsx**: スクリーンショット画像表示
    - base64スクリーンショット表示
    - 画像フォーマット・サイズ調整
  - **MessageDisplay.tsx**: 各種メッセージ表示
    - メッセージフィルタリング
    - システム/LLM/スクリーンショットメッセージ表示調整
    - ストリーミングセグメント対応
  - **OutputHeader.tsx**: 出力セクションヘッダー・トグル制御
    - 履歴クリア機能
    - システムメッセージ表示トグル
  - **PromptForm.tsx**: 入力フォーム・送信処理
    - プロンプト入力管理
    - フォーム送信処理
    - 処理中のキャンセル機能
  - **TabStatusBar.tsx**: 現在のタブ情報表示
    - アクティブタブID・タイトル表示
    - 接続状態表示
  - **TokenUsageDisplay.tsx**: トークン使用量・プロバイダー情報表示
    - 現在のLLMプロバイダー・モデル表示
    - 入出力トークン追跡
    - 推定コスト表示

- **sidepanel/hooks/**: 状態・機能用カスタムReactフック
  - **useTabManagement.ts**: タブ関連機能管理
    - タブ接続処理
    - タブ状態追跡
    - タブ情報更新
  - **useMessageManagement.ts**: メッセージ状態・処理管理
    - メッセージ履歴管理
    - ストリーミング状態制御
    - メッセージ操作機能
  - **useChromeMessaging.ts**: Chrome拡張API通信管理
    - Chromeメッセージ受信
    - バックグラウンドスクリプトへの送信
    - メッセージ処理

#### オプションページ

- **options/Options.tsx**: オプションUIのメインコンポーネント
  - 状態・設定管理
  - 全オプションコンポーネント構成
- **options/index.tsx**: オプションページのエントリポイント
- **options/components/**: オプションページ用モジュラー型UIコンポーネント
  - **AboutSection.tsx**: 「About」情報表示
  - **ProviderSelector.tsx**: プロバイダー選択処理
  - **AnthropicSettings.tsx**, **OpenAISettings.tsx**, **GeminiSettings.tsx**, **OllamaSettings.tsx**: プロバイダー別設定
  - **OpenAICompatibleSettings.tsx**: OpenAI互換プロバイダー用設定
  - **ModelList.tsx**: OpenAI互換プロバイダー用モデルリスト管理
  - **OllamaModelList.tsx**: Ollama用カスタムモデルリスト管理
  - **ModelPricingTable.tsx**: モデル価格情報表示
  - **MemoryManagement.tsx**: メモリのエクスポート/インポート機能
  - **SaveButton.tsx**: 設定保存機能
  - **LLMProviderConfig.tsx**: プロバイダー選択・設定統合
  - **ProviderSettings.tsx**: 適切なプロバイダー設定コンポーネント表示

### トラッキングモジュール

トラッキングモジュールは、メモリ保存、トークン追跡、その他トラッキング関連機能を担当します。

- **tracking/memoryService.ts**: エージェントメモリ保存・取得管理
  - IndexedDB操作
  - メモリ保存・取得
  - 自己修復型DB機能
- **tracking/tokenTrackingService.ts**: APIコール用トークン使用量追跡
- **tracking/screenshotManager.ts**: スクリーンショット保存・取得管理
- **tracking/domainUtils.ts**: ドメイン操作用ユーティリティ

## データフロー

1. ユーザーがサイドパネルでプロンプト入力
2. プロンプトがバックグラウンドモジュールへ送信
3. バックグラウンドモジュールが設定済みLLMプロバイダーでエージェント初期化
4. エージェントがプロンプト処理・ブラウザ操作実行
   - TokenManagerがトークン推定・履歴トリミング
   - PromptManagerがシステムプロンプト生成
   - ExecutionEngineが実行フロー管理
   - ToolManagerがブラウザツール提供
   - MemoryManagerが関連メモリ統合
   - ErrorHandlerがエラー処理
5. 結果がサイドパネルへストリーミング
6. サイドパネルが結果をユーザーに表示

## コンポーネント関係

- サイドパネルはChromeメッセージングでバックグラウンドモジュールと通信
- バックグラウンドモジュールがエージェント管理・調整
- エージェントコアが各専門コンポーネント（TokenManager, ToolManager等）を統括
- 各専門コンポーネントが特定機能を担当
- エージェントはツールでブラウザ操作
- トラッキングモジュールが永続化・監視サービス提供
- オプションページがバックグラウンドモジュール用設定を管理
- モデルモジュールが複数LLMプロバイダー用インターフェース提供

## プロバイダーシステム

## Ollama統合

Ollama統合により、ローカル稼働Ollamaモデルへの接続が可能です。

1. **ブラウザ互換性**: ブラウザ対応Ollamaライブラリ使用
2. **APIキー不要**: 他プロバイダーと異なりAPIキー不要
3. **CORS設定**: OllamaサーバーでCORS有効化必須
4. **カスタムモデル**: ユーザー定義カスタムモデル対応（コンテキストウィンドウ設定可）
5. **設定要件**: ベースURLと少なくとも1つのカスタムモデル設定必須
6. **プライバシー重視**: クラウド型LLMプロバイダーの代替となるプライバシー重視設計

プロバイダーシステムは以下の設計パターンを採用：

1. **インターフェース分離**: 各プロバイダーが共通インターフェース実装
2. **ファクトリーパターン**: ファクトリー関数で適切なプロバイダー生成
3. **アダプターパターン**: 各プロバイダーが独自APIを共通インターフェースに適合
4. **ストラテジーパターン**: 実行時にプロバイダー切替可能
5. **シングルトンパターン**: ConfigManagerが設定の単一アクセスポイント提供

## ファイル構成

プロジェクトは、関心の分離を明確にしたモジュラー構成です。

- 各モジュールは独自ディレクトリを持つ
- コンポーネントは機能別に整理
- 型定義は使用箇所近くに配置
- フックは関連状態・機能をカプセル化
- ユーティリティ関数は専用ファイルに分離

## 設計原則

1. **関心の分離**: 各コンポーネント・モジュールは単一責任
2. **モジュール性**: 独立開発・テスト可能な構成
3. **再利用性**: 共通機能は再利用可能なコンポーネント・フックに抽出
4. **型安全性**: TypeScriptによる型安全性確保
5. **保守性**: 理解・保守しやすいコード整理
6. **耐障害性**: 重要コンポーネントに自己修復機構実装
7. **ライフサイクル管理**: 拡張機能のインストール・更新・アンインストール対応
8. **プロバイダー抽象化**: LLMプロバイダーは共通インターフェースで抽象化

